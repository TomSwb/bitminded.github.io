<!-- Step 6: Cloudflare Configuration -->
<div class="step-cloudflare-setup" id="step-cloudflare-setup">
    <div class="step-cloudflare-setup__header">
        <h2>Step 6: Cloudflare Configuration</h2>
        <p>Configure the Cloudflare subdomain and worker for your product</p>
    </div>

    <div class="step-cloudflare-setup__fields">
        <!-- Subdomain Configuration -->
        <div class="step-cloudflare-setup__field-group">
            <label for="cloudflare-subdomain" class="step-cloudflare-setup__label">
                Subdomain <span class="required">*</span>
            </label>
            <div class="step-cloudflare-setup__subdomain-input">
                <input type="text" id="cloudflare-subdomain" class="step-cloudflare-setup__input" placeholder="product-slug">
                <span class="step-cloudflare-setup__subdomain-suffix">.bitminded.ch</span>
            </div>
            <small class="step-cloudflare-setup__help">The subdomain where your product will be hosted (e.g., converter.bitminded.ch)</small>
        </div>

        <!-- Cloudflare Worker URL -->
        <div class="step-cloudflare-setup__field-group">
            <label for="cloudflare-worker-url" class="step-cloudflare-setup__label">
                Cloudflare Worker URL (Optional)
            </label>
            <input type="url" id="cloudflare-worker-url" class="step-cloudflare-setup__input" placeholder="https://your-worker.your-subdomain.workers.dev">
            <small class="step-cloudflare-setup__help">Your Cloudflare Worker URL if you have one set up</small>
        </div>

        <!-- Create Worker Button -->
        <div class="step-cloudflare-setup__create-section">
            <button type="button" id="create-worker-btn" class="step-cloudflare-setup__create-btn">
                <span class="btn-icon">‚òÅÔ∏è</span>
                <span>Create Cloudflare Worker</span>
            </button>
            <small class="step-cloudflare-setup__help">Automatically create and configure a Cloudflare Worker for this product</small>
        </div>

        <!-- Worker Status -->
        <div class="step-cloudflare-setup__status" id="worker-status" style="display: none;">
            <!-- Status will be shown here -->
        </div>

        <!-- Recreate Worker Button (shown when worker exists) -->
        <div class="step-cloudflare-setup__recreate-section" id="recreate-worker-section" style="display: none;">
            <button type="button" id="recreate-worker-btn" class="step-cloudflare-setup__create-btn step-cloudflare-setup__create-btn--secondary">
                <span class="btn-icon">üîÑ</span>
                <span>Recreate Worker (Use Latest Edge Function)</span>
            </button>
            <small class="step-cloudflare-setup__help">Regenerate the Cloudflare Worker with the latest Edge Function code</small>
        </div>

        <!-- Expo/React Native Warning (shown conditionally) -->
        <div class="step-cloudflare-setup__warning" id="expo-deployment-warning" style="display: none; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <h4 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Expo/React Native App Detected</h4>
            <p style="margin-bottom: 0.5rem; color: #856404;"><strong>This app uses the <code>gh-pages</code> branch for deployment.</strong></p>
            <p style="margin-bottom: 0.5rem; color: #856404;">Make sure:</p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: #856404;">
                <li>GitHub Pages is configured to use the <code>gh-pages</code> branch (Settings ‚Üí Pages ‚Üí Source: <code>gh-pages</code> branch)</li>
                <li>Cloudflare Worker is connected to the <code>gh-pages</code> branch (not <code>main</code>)</li>
                <li>Worker files (<code>worker-updated.js</code>, <code>wrangler.toml</code>) are on the <code>gh-pages</code> branch</li>
                <li>After building, run <code>npm run deploy</code> to build and deploy to <code>gh-pages</code></li>
            </ul>
        </div>

        <!-- How it works -->
        <div class="step-cloudflare-setup__instructions">
            <h3 class="step-cloudflare-setup__instructions-title">How it works</h3>
            <div class="step-cloudflare-setup__instruction-step">
                <ul>
                    <li>Creates a Cloudflare Worker and sets the route for <strong id="subdomain-preview">[subdomain].bitminded.ch</strong>.</li>
                    <li>Enforces access automatically via Supabase (validate-license) with admin bypass.</li>
                    <li>Unauthenticated users are redirected to login; non-subscribers to subscribe.</li>
                    <li>Worker serves files directly from your repository (via Workers Assets) or proxies to GitHub Pages if enabled.</li>
                </ul>
            </div>
            <div class="step-cloudflare-setup__instruction-step">
                <h4>Cloudflare Worker Deployment Setup</h4>
                <p><strong>Important:</strong> For full protection, configure the Worker to deploy directly from your repository:</p>
                <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li>Go to <a href="https://dash.cloudflare.com" target="_blank" rel="noopener">Cloudflare Dashboard</a> ‚Üí <strong>Workers & Pages</strong></li>
                    <li>Click <strong>Create application</strong> ‚Üí <strong>Create Worker</strong></li>
                    <li>Click <strong>Connect to Git</strong> and select your repository: <strong id="github-repo-link">[Repository URL]</strong></li>
                    <li>Select the <strong id="deployment-branch-name">main</strong> branch <span id="expo-branch-note" style="display: none;">(or <strong>gh-pages</strong> for Expo/React Native apps)</span></li>
                    <li><strong>DO NOT enable GitHub Pages</strong> - Keep it disabled for full protection</li>
                    <li>Set the <strong>Deploy command</strong> to: <code>npx wrangler deploy worker-updated.js</code></li>
                    <li>Or use: <code>npm run deploy</code> (if package.json has deploy script)</li>
                    <li>Click <strong>Save and Deploy</strong></li>
                </ol>
                <p style="margin-top: 0.75rem;"><strong>Why this approach:</strong></p>
                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li>‚úÖ <strong>Full Protection:</strong> App is only accessible via Cloudflare Worker (with auth checks)</li>
                    <li>‚úÖ <strong>No Public Access:</strong> GitHub Pages disabled = no direct access to static files</li>
                    <li>‚úÖ <strong>Secure:</strong> All requests go through authentication/subscription validation</li>
                    <li>‚úÖ <strong>Single Entry Point:</strong> Subdomain points to Worker, Worker serves files</li>
                </ul>
                <p style="margin-top: 0.75rem;"><strong>Note:</strong> Your repository must contain <code>wrangler.toml</code> and <code>worker-updated.js</code> for this to work. The access protection script is automatically included in your repo's index.html.</p>
            </div>
            <div class="step-cloudflare-setup__instruction-step">
                <h4>Configure Subdomain Route</h4>
                <p>After the Worker is created, configure the subdomain route:</p>
                <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li>Go to Cloudflare Dashboard ‚Üí <strong>Workers & Pages</strong> ‚Üí Your Worker</li>
                    <li>Click <strong>Triggers</strong> tab</li>
                    <li>Under <strong>Custom Domains</strong>, click <strong>Add Custom Domain</strong></li>
                    <li>Enter: <strong id="subdomain-preview-route">[subdomain].bitminded.ch</strong></li>
                    <li>Click <strong>Add Custom Domain</strong></li>
                    <li>Update DNS if needed (Cloudflare will guide you)</li>
                </ol>
                <p style="margin-top: 0.75rem;"><strong>Important:</strong> The subdomain must point to the Cloudflare Worker, NOT to GitHub Pages.</p>
                <p><a href="https://dash.cloudflare.com" target="_blank" rel="noopener">Open Cloudflare Dashboard</a></p>
            </div>
        </div>

        <!-- Info Box -->
        <div class="step-cloudflare-setup__info">
            <p><strong>üí° Pro Tip:</strong> You can come back and update the Worker URL after it's created.</p>
            <p><strong>üîí Security:</strong> Access enforcement is handled automatically by the generated Worker.</p>
        </div>
    </div>
</div>

